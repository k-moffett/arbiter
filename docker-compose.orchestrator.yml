# Docker Compose - Agent Orchestrator Service
# Central orchestration service for processing queries with context awareness

networks:
  arbiter-network:
    driver: bridge
    name: arbiter-network

services:
  # ===========================================================================
  # Agent Orchestrator Service
  # ===========================================================================
  agent-orchestrator:
    build:
      context: .
      dockerfile: docker/services/Dockerfile.orchestrator
      target: production
    container_name: arbiter-agent-orchestrator
    restart: unless-stopped  # Persist - core service
    ports:
      - "3200:3200"  # HTTP API
    environment:
      # Service URLs (Docker networking)
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://mcp-server:3100}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-180000}

      # Model configuration
      - LLM_MODEL=${LLM_MODEL:-qwen2.5:14b}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - QUERY_DECOMPOSER_MODEL=${QUERY_DECOMPOSER_MODEL}
      - QUERY_ENHANCER_MODEL=${QUERY_ENHANCER_MODEL}
      - RAG_VALIDATOR_MODEL=${RAG_VALIDATOR_MODEL}
      - QUALITY_GRADER_MODEL=${QUALITY_GRADER_MODEL}
      - TOOL_PLANNER_MODEL=${TOOL_PLANNER_MODEL}

      # Context window configuration
      - CONTEXT_MAX_TOKENS=${CONTEXT_MAX_TOKENS:-12288}
      - CONTEXT_MIN_RESPONSE_TOKENS=${CONTEXT_MIN_RESPONSE_TOKENS:-512}
      - CONTEXT_CHARS_PER_TOKEN=${CONTEXT_CHARS_PER_TOKEN:-4}

      # Server configuration
      - ORCHESTRATOR_PORT=${ORCHESTRATOR_PORT:-3200}

      # Node.js settings
      - NODE_ENV=${NODE_ENV:-production}
      - NODE_OPTIONS=${NODE_OPTIONS:---max-old-space-size=2048}

      # Logging configuration
      - LOG_PREFIX=${LOG_PREFIX:-[ARBITER]}
      - LOG_FORMAT=${LOG_FORMAT:-text}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_USE_COLORS=${LOG_USE_COLORS:-true}
    networks:
      arbiter-network:
        aliases:
          - agent-orchestrator  # DNS alias for CLI connectivity
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
